<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Golang httptest Example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <meta name="title" content="Golang httptest Example" />
    <meta name="keywords" content="golang httptest exmaple, go httptest example, golang httptest, go httptest, golang http server testing, golang http client testing, golang test http server, golang test http client, golang http test" />
    <meta name="description" content="In this article we are going to look at how to use the httptest package effectively to cover our Go code when dealing with http servers" />
    <meta itemprop="name" content="Golang httptest Example">
    <meta itemprop="description" content="In this article we are going to look at how to use the httptest package effectively to cover our Go code when dealing with http servers">
    <meta itemprop="image" content="https://golang.cafe/s/img/cafe.jpg">
    <meta property="og:url" content="https://golang.cafe">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Golang httptest Example">
    <meta property="og:description" content="In this article we are going to look at how to use the httptest package effectively to cover our Go code when dealing with http servers">
    <meta property="og:image" content="https://golang.cafe/s/img/cafe.jpg">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Golang httptest Example">
    <meta name="twitter:description" content="In this article we are going to look at how to use the httptest package effectively to cover our Go code when dealing with http servers">
    <meta name="twitter:image" content="https://golang.cafe/s/img/cafe.jpg">
    <meta name="twitter:site" content="@golangcafe"/>
    <style type="text/css">
body{background:#f7f7f7;}
      input,textarea,select,button,option,html,body{font-family:Verdana, sans-serif;font-size:18px;font-stretch:normal;font-style:normal;font-weight:400;line-height:29.7px}input,textarea,select,button,option,html,body{font-family:Verdana, sans-serif;font-size:18px;font-stretch:normal;font-style:normal;font-weight:400;line-height:29.7px}th{font-weight:600}td,th{border-bottom:1.08px solid #595959;overflow:auto;padding:14.85px 18px;text-align:left;vertical-align:top}thead th{border-bottom-width:2.16px;padding-bottom:6.3px}table{display:table;overflow-x:auto}input,textarea,select,button,option,html,body{font-family:Verdana, sans-serif;font-size:18px;font-stretch:normal;font-style:normal;font-weight:400;line-height:29.7px}fieldset{display:flex;flex-direction:row;flex-wrap:wrap}fieldset legend{margin:18px 0}input,textarea,select,button{border-radius:3.6px;display:inline-block;padding:9.9px}input+label,input+input[type="checkbox"],input+input[type="radio"],textarea+label,textarea+input[type="checkbox"],textarea+input[type="radio"],select+label,select+input[type="checkbox"],select+input[type="radio"],button+label,button+input[type="checkbox"],button+input[type="radio"]{page-break-before:always}input,select,label{margin-right:3.6px}textarea{min-height:90px;min-width:360px}label{display:inline-block;margin-bottom:12.6px}label+*{page-break-before:always}label>input{margin-bottom:0}input[type="submit"],input[type="reset"],button{background:#f2f2f2;color:#191919;cursor:pointer;display:inline;margin-bottom:18px;margin-right:7.2px;padding:6.525px 23.4px;text-align:center}input[type="submit"]:hover,input[type="reset"]:hover,button:hover{background:#d9d9d9;color:#000}input[type="submit"][disabled],input[type="reset"][disabled],button[disabled]{background:#e6e5e5;color:#403f3f;cursor:not-allowed}input[type="submit"],button[type="submit"]{background:#000090;color:#fff}input[type="submit"]:hover,button[type="submit"]:hover{background:#0000c5;color:#ffffff}input,select,textarea{margin-bottom:18px}input[type="text"],input[type="password"],input[type="email"],input[type="url"],input[type="phone"],input[type="tel"],input[type="number"],input[type="datetime"],input[type="date"],input[type="month"],input[type="week"],input[type="color"],input[type="time"],input[type="search"],input[type="range"],input[type="file"],input[type="datetime-local"],select,textarea{border:1px solid #595959;padding:5.4px 6.3px}input[type="checkbox"],input[type="radio"]{flex-grow:0;height:29.7px;margin-left:0;margin-right:9px;vertical-align:middle}input[type="checkbox"]+label,input[type="radio"]+label{page-break-before:avoid}select[multiple]{min-width:270px}input,textarea,select,button,option,html,body{font-family:Verdana, sans-serif;font-size:18px;font-stretch:normal;font-style:normal;font-weight:400;line-height:29.7px}kbd,samp,var,output{font-family:Menlo,Monaco,Consolas,"Courier New",monospace;font-size:14.4px}pre{border-left:1.8px solid #59c072;line-height:25.2px;overflow:auto;padding-left:18px}kbd{background:#daf1e0;border-radius:3.6px;color:#2a6f3b;display:inline-block;line-height:18px;padding:3.6px 6.3px 2.7px}kbd{background:#2a6f3b;color:#fff}mark{background:#ffc;padding:0 3.6px}input,textarea,select,button,option,html,body{font-family:Verdana, sans-serif;font-size:18px;font-stretch:normal;font-style:normal;font-weight:400;line-height:29.7px}h1,h2,h3,h4,h5,h6{color:#000;margin-bottom:18px}h1{font-size:36px;font-weight:500;line-height:41.4px;margin-top:72px}h2{font-size:25.2px;font-weight:400;line-height:30.6px;margin-top:54px}h3{font-size:21.6px;line-height:27px;margin-top:36px}h4{font-size:18px;line-height:23.4px;margin-top:18px}h5{font-size:14.4px;font-weight:bold;line-height:21.6px;text-transform:uppercase}h6{color:#595959;font-size:14.4px;font-weight:bold;line-height:18px;text-transform:uppercase}input,textarea,select,button,option,html,body{font-family:Verdana, sans-serif;font-size:18px;font-stretch:normal;font-style:normal;font-weight:400;line-height:29.7px}a{color:#000090;text-decoration:none}a:hover{text-decoration:underline}hr{border-bottom:1px solid #595959}figcaption,small{font-size:15.3px}figcaption{color:#595959}var,em,i{font-style:italic}dt,strong,b{font-weight:600}del,s{text-decoration:line-through}ins,u{text-decoration:underline}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}*{border:0;border-collapse:separate;border-spacing:0;box-sizing:border-box;margin:0;max-width:100%;outline:0;padding:0;vertical-align:baseline}html,body{width:100%}html{height:100%}body{color:#1a1919;}p,ul,ol,dl,blockquote,hr,pre,table,form,fieldset,figure,address{margin-bottom:29.7px}section{margin-left:auto;margin-right:auto;width:780px}article,header,footer{padding:43.2px}article{word-wrap: break-word;background:#fff;border:1px solid #d9d9d9;border-radius:7.2px}nav{text-align:center}nav ul{list-style:none;margin-left:0;text-align:center}nav ul li{display:inline-block;margin-left:9px;margin-right:9px;vertical-align:middle}nav ul li:last-child{margin-right:0}ol,ul{margin-left:31.5px}li dl,li ol,li ul{margin-bottom:0}dl{display:inline-block}dt{padding:0 18px}dd{padding:0 18px 4.5px}dd:last-of-type{border-bottom:1.08px solid #595959}dd+dt{border-top:1.08px solid #595959;padding-top:9px}blockquote{border-left:2.16px solid #595959;padding:4.5px 18px 4.5px 15.84px}blockquote footer{color:#595959;font-size:13.5px;margin:0}blockquote p{margin-bottom:0}img{height:auto;margin:0 auto}figure img{display:block}/*# sourceMappingURL=tacit-css-1.3.2.min.css.map */
      input{-webkit-appearance: none;-moz-appearance: none;appearance: none;}
      #carbonads{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",Helvetica,Arial,sans-serif}#carbonads{display:inline;max-width:330px;background-color:#f9f9f9;box-shadow:0 1px 4px 1px hsla(0,0%,0%,.1)}#carbonads a{color:inherit;text-decoration:none}#carbonads a:hover{color:inherit}#carbonads span{position:relative;display:block;overflow:hidden}#carbonads .carbon-wrap{display:flex}.carbon-img{display:block;margin:0;line-height:1}.carbon-img img{display:block}.carbon-text{font-size:13px;padding:10px;line-height:1.5;text-align:left}.carbon-poweredby{display:block;padding:8px 10px;background:repeating-linear-gradient(-45deg,transparent,transparent 5px,hsla(0,0%,0%,.025) 5px,hsla(0,0%,0%,.025) 10px) hsla(203,11%,95%,.4);text-align:center;text-transform:uppercase;letter-spacing:.5px;font-weight:600;font-size:9px;line-height:1}
        .menu-header{width: 100%;margin:20px auto;padding:10px;}.menu-header a {white-space:pre;color: black;font-size: 20px;font-weight: bold;padding: 15px;}
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/themes/prism.min.css" rel="stylesheet" />
  </head>
  <body>
    <header style="padding:0;">
      <nav class="menu-header">
        <small>
            <a href="/">üíº Jobs</a>
            <a href="/Golang-Developer-Salary-Remote">üìä Salaries</a>
            <a href="/Companies-Using-Golang">üè¢ Companies</a>
            <a href="/Golang-Developers">üë§ Developers</a>
          <br>
        </small>
      </nav>
    </header>
    <section style="margin:30px auto;">
      <article>
<h1 class="code-line" data-line-start=0 data-line-end=1 ><a id="Golang_httptest_Example_0"></a>Golang httptest Example</h1>
<p class="has-line-data" data-line-start="2" data-line-end="3">Go (Golang) struck me when I first learned about its HTTP testing package. In other programming languages I have been used to have to do a lot of work for testing HTTP servers. In Go (Golang) this isn‚Äôt the case. There is an amazing testing package that can be used right away from the standard library and it‚Äôs extremely easy to understand. Let‚Äôs have a look at how you can use the httptest package and build better end-to-end and http tests for your Go http services.</p>
<script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7ITK3J&placement=golangcafe" id="_carbonads_js"></script><br />
<p class="has-line-data" data-line-start="4" data-line-end="5">The idea behind the httptest package is that it‚Äô pretty easy to mock an HTTP server or to mock a response writer to feed into our server handlers. This makes it extremely easy to test http servers and clients.</p>
<p class="has-line-data" data-line-start="6" data-line-end="7">In this article we are going to explore two specific scenarios where the <a href="https://golang.org/pkg/net/http/httptest/">httptest package</a> can be useful</p>
<ul>
<li class="has-line-data" data-line-start="8" data-line-end="9">testing Go http server handlers</li>
<li class="has-line-data" data-line-start="9" data-line-end="11">testing Go http clients</li>
</ul>
<h2 class="code-line" data-line-start=11 data-line-end=12 ><a id="Testing_Go_HTTP_Server_Handlers_11"></a>Testing Go HTTP Server Handlers</h2>
<p class="has-line-data" data-line-start="13" data-line-end="14">Let‚Äôs see an example of our http server in Go. Here below you can find an example of a server that takes a word and returns the upper case version of the same.</p>
<pre><code class="language-go" data-line-start="16" data-line-end="50">package main

import (
    "fmt"
    "log"
    "net/http"
    "net/url"
    "strings"
)

// Req: http://localhost:1234/upper?word=abc
// Res: ABC
func upperCaseHandler(w http.ResponseWriter, r *http.Request) {
    query, err := url.ParseQuery(r.URL.RawQuery)
    if err != nil {
        w.WriteHeader(http.StatusBadRequest)
        fmt.Fprintf(w, "invalid request")
        return
    }
    word := query.Get("word")
    if len(word) == 0 {
        w.WriteHeader(http.StatusBadRequest)
        fmt.Fprintf(w, "missing word")
        return
    }
    w.WriteHeader(http.StatusOK)
    fmt.Fprintf(w, strings.ToUpper(word))
}

func main() {
    http.HandleFunc("/upper", upperCaseHandler)
    log.Fatal(http.ListenAndServe(":1234", nil))
}
</code></pre>
<p class="has-line-data" data-line-start="51" data-line-end="52">In this scenario we want to test the <code>upperCaseHandler</code> logic that is used for our Go server. We will need two things to test that:</p>
<ul>
<li class="has-line-data" data-line-start="53" data-line-end="55"><a href="https://golang.org/pkg/net/http/#Request">http.Request</a> that can be created using <a href="https://golang.org/pkg/net/http/httptest/#NewRequest">httptest.NewRequest</a> exported function</li>
</ul>
<blockquote>
<p class="has-line-data" data-line-start="55" data-line-end="56">NewRequest returns a new incoming server Request, suitable for passing to an http.Handler for testing.</p>
</blockquote>
<ul>
<li class="has-line-data" data-line-start="58" data-line-end="60"><a href="https://golang.org/pkg/net/http/#ResponseWriter">http.ResponseWriter</a> that can be created by using <a href="https://golang.org/pkg/net/http/httptest/#NewRecorder">httptest.NewRecorder</a> type which returns a <a href="https://golang.org/pkg/net/http/httptest/#ResponseRecorder">httptest.ResponseRecorder</a></li>
</ul>
<blockquote>
<p class="has-line-data" data-line-start="60" data-line-end="61">ResponseRecorder is an implementation of http.ResponseWriter that records its mutations for later inspection in tests.</p>
</blockquote>
<h3 class="code-line" data-line-start=62 data-line-end=63 ><a id="Using_httptestResponseRecorder_62"></a>Using httptest.ResponseRecorder</h3>
<p class="has-line-data" data-line-start="64" data-line-end="65">The <a href="https://golang.org/pkg/net/http/httptest/#ResponseRecorder">httptest.ResponseRecorder</a> is an implementation of <a href="https://golang.org/pkg/net/http/#ResponseWriter">http.ResponseWriter</a> and can be used to be passed into our server handler, record all the data that the handler will write to the response and return the data written afterwards. Let‚Äôs see how that works in the example test below.</p>
<pre><code class="language-go" data-line-start="67" data-line-end="91">package main

import (
    "io/ioutil"
    "net/http"
    "net/http/httptest"
    "testing"
)

func TestUpperCaseHandler(t *testing.T) {
    req := httptest.NewRequest(http.MethodGet, "/upper?word=abc", nil)
    w := httptest.NewRecorder()
    upperCaseHandler(w, req)
    res := w.Result()
    defer res.Body.Close()
    data, err := ioutil.ReadAll(res.Body)
    if err != nil {
        t.Errorf("expected error to be nil got %v", err)
    }
    if string(data) != "ABC" {
        t.Errorf("expected ABC got %v", string(data))
    }
}
</code></pre>
<p class="has-line-data" data-line-start="92" data-line-end="93">This will allows us to test the handler response by inspecting the ResponseRecorder output returned by the <a href="https://golang.org/pkg/net/http/httptest/#ResponseRecorder.Result">Result</a> method</p>
<pre><code class="language-go" data-line-start="95" data-line-end="97">func (rw *ResponseRecorder) Result() *http.Response
</code></pre>
<blockquote>
<p class="has-line-data" data-line-start="98" data-line-end="100">Result returns the response generated by the handler.<br>
The returned Response will have at least its StatusCode, Header, Body, and optionally Trailer populated. More fields may be populated in the future, so callers should not DeepEqual the result in tests.</p>
</blockquote>
<h2 class="code-line" data-line-start=101 data-line-end=102 ><a id="Testing_Go_HTTP_Clients_101"></a>Testing Go HTTP Clients</h2>
<p class="has-line-data" data-line-start="103" data-line-end="104">Testing Go server handlers is relatively easy, especially when you want to test just the handler logic. You just need to mock http.ResponseWriter and http.Request objects in your tests. When working with a Go http client though, things are a little more complicated. The reason is that sometimes is not as easy to mock or replicate an entire server. Let‚Äôs see our example below.</p>
<pre><code class="language-go" data-line-start="106" data-line-end="137">package main

import (
    "io/ioutil"
    "net/http"

    "github.com/pkg/errors"
)

type Client struct {
    url string
}

func NewClient(url string) Client {
    return Client{url}
}

func (c Client) UpperCase(word string) (string, error) {
    res, err := http.Get(c.url + "/upper?word=" + word)
    if err != nil {
        return "", errors.Wrap(err, "unable to complete Get request")
    }
    defer res.Body.Close()
    out, err := ioutil.ReadAll(res.Body)
    if err != nil {
        return "", errors.Wrap(err, "unable to read response data")
    }

    return string(out), nil
}
</code></pre>
<p class="has-line-data" data-line-start="138" data-line-end="139">Our Go client requires a base URL which represents a remote server base URL. It then calls the method <code>/upper</code> with a given input word and returns the result to the caller as a string, or an error in case the request did not succeed. In order to test this code we will need to mock the entire server logic or at least the logic that is responsible for a given request path, like in our case the <code>/upper</code> path. With the httptest package we can mock the entire server by initialising a local server listening on the loopback interface which will return anything we want.</p>
<h3 class="code-line" data-line-start=140 data-line-end=141 ><a id="Using_httptestServer_140"></a>Using httptest.Server</h3>
<p class="has-line-data" data-line-start="142" data-line-end="143">The type we are going to use is the <a href="https://golang.org/pkg/net/http/httptest/#Server">httptest.Server</a> type by calling the <a href="https://golang.org/pkg/net/http/httptest/#NewServer">httptest.NewServer</a> function.</p>
<blockquote>
<p class="has-line-data" data-line-start="144" data-line-end="145">A Server is an HTTP server listening on a system-chosen port on the local loopback interface, for use in end-to-end HTTP tests.</p>
</blockquote>
<pre><code class="language-go" data-line-start="148" data-line-end="150">func NewServer(handler http.Handler) *Server
</code></pre>
<blockquote>
<p class="has-line-data" data-line-start="150" data-line-end="151">NewServer starts and returns a new Server. The caller should call Close when finished, to shut it down.</p>
</blockquote>
<p class="has-line-data" data-line-start="153" data-line-end="154">Let‚Äôs see how we can do that in the example below.</p>
<pre><code class="language-go" data-line-start="156" data-line-end="185">package main

import (
    "fmt"
    "net/http"
    "net/http/httptest"
    "strings"
    "testing"
)

func TestClientUpperCase(t *testing.T) {
    expected := "dummy data"
    svr := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        fmt.Fprintf(w, expected)
    }))
    defer svr.Close()
    c := NewClient(svr.URL)
    res, err := c.UpperCase("anything")
    if err != nil {
        t.Errorf("expected err to be nil got %v", err)
    }
    // res: expected\r\n
    // due to the http protocol cleanup response
    res = strings.TrimSpace(res)
    if res != expected {
        t.Errorf("expected res to be %s got %s", expected, res)
    }
}
</code></pre>
<p class="has-line-data" data-line-start="186" data-line-end="187">In the example above we just created a new mock server using the httptest.NewServer function, assigned it a custom mock handler that returns always the same data and used the server URL as our client‚Äôs server URL. This allows us to mock and instruct the server to return anything we want for testing purposes.</p>
<p class="has-line-data" data-line-start="188" data-line-end="189">Checkout this example source code on the Go Playground <a href="https://play.golang.org/p/xQ6xRbyvOJQ">https://play.golang.org/p/xQ6xRbyvOJQ</a></p>
<script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7ITK3J&placement=golangcafe" id="_carbonads_js"></script><br />
<iframe width="560" height="315" src="https://www.youtube.com/embed/LqU-0RVyq8I" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </article>
          <article class="line-item" style="margin-top:20px;">
		  <div style="width: 50%;font-size:15pt;text-align:center;font-weight:bold;display:table;margin:20px auto;" id="email-subscribe-item-text">Ready for your next Go Job? Submit your profile and get hired on Golang Cafe</div>
                <input type="submit" onclick="window.location.href='/Submit-Developer-Profile'" id="email-subscribe-item-btn" value="Get Hired" style="width:50%;display:table;margin:5px auto;"/>
            </article>
  </section>
  <footer>
    <nav>
      <small>    
        <a href="/">Golang Jobs</a> &bull;
        <a href="/about">About Golang Cafe</a>
        <br>
      </small>
    </nav>
  </footer>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/prism.min.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-go.min.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-javascript.js"></script>

  <script src="//instant.page/5.1.0" type="module" integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw"></script>
</body>
</html>
