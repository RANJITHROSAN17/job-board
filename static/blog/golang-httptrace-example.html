<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Golang httptrace Example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <meta name="title" content="Golang httptrace Example" />
    <meta name="keywords" content="golang httptrace, golang httptrace example, golang tutorial, golang httptrace tutorial, golang http requests" />
    <meta name="description" content="In this article we are going to see how to use the Golang httptrace package effectively to trace http request/response data" />
    <meta itemprop="name" content="Golang httptrace Example">
    <meta itemprop="description" content="In this article we are going to see how to use the Golang httptrace package effectively to trace http request/response data">
    <meta itemprop="image" content="https://golang.cafe/s/img/cafe.jpg">
    <meta property="og:url" content="https://golang.cafe">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Golang httptrace Example">
    <meta property="og:description" content="In this article we are going to see how to use the Golang httptrace package effectively to trace http request/response data">
    <meta property="og:image" content="https://golang.cafe/s/img/cafe.jpg">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Golang httptrace Example">
    <meta name="twitter:description" content="In this article we are going to see how to use the Golang httptrace package effectively to trace http request/response data">
    <meta name="twitter:image" content="https://golang.cafe/s/img/cafe.jpg">
    <meta name="twitter:site" content="@golangcafe"/>
    <style type="text/css">
body{background:#ffffff;}
      input,textarea,select,button,option,html,body{font-family:Helvetica;font-size:18px;font-stretch:normal;font-style:normal;font-weight:400;line-height:29.7px}input,textarea,select,button,option,html,body{font-family:Helvetica;font-size:18px;font-stretch:normal;font-style:normal;font-weight:400;line-height:29.7px}th{font-weight:600}td,th{border-bottom:1.08px solid #595959;overflow:auto;padding:14.85px 18px;text-align:left;vertical-align:top}thead th{border-bottom-width:2.16px;padding-bottom:6.3px}table{display:table;overflow-x:auto}input,textarea,select,button,option,html,body{font-family:Helvetica;font-size:18px;font-stretch:normal;font-style:normal;font-weight:400;line-height:29.7px}fieldset{display:flex;flex-direction:row;flex-wrap:wrap}fieldset legend{margin:18px 0}input,textarea,select,button{border-radius:3.6px;display:inline-block;padding:9.9px}input+label,input+input[type="checkbox"],input+input[type="radio"],textarea+label,textarea+input[type="checkbox"],textarea+input[type="radio"],select+label,select+input[type="checkbox"],select+input[type="radio"],button+label,button+input[type="checkbox"],button+input[type="radio"]{page-break-before:always}input,select,label{margin-right:3.6px}textarea{min-height:90px;min-width:360px}label{display:inline-block;margin-bottom:12.6px}label+*{page-break-before:always}label>input{margin-bottom:0}input[type="submit"],input[type="reset"],button{background:#f2f2f2;color:#191919;cursor:pointer;display:inline;margin-bottom:18px;margin-right:7.2px;padding:6.525px 23.4px;text-align:center}input[type="submit"]:hover,input[type="reset"]:hover,button:hover{background:#d9d9d9;color:#000}input[type="submit"][disabled],input[type="reset"][disabled],button[disabled]{background:#e6e5e5;color:#403f3f;cursor:not-allowed}input[type="submit"],button[type="submit"]{background:#000090;color:#fff}input[type="submit"]:hover,button[type="submit"]:hover{background:#0000c5;color:#ffffff}input,select,textarea{margin-bottom:18px}input[type="text"],input[type="password"],input[type="email"],input[type="url"],input[type="phone"],input[type="tel"],input[type="number"],input[type="datetime"],input[type="date"],input[type="month"],input[type="week"],input[type="color"],input[type="time"],input[type="search"],input[type="range"],input[type="file"],input[type="datetime-local"],select,textarea{border:1px solid #595959;padding:5.4px 6.3px}input[type="checkbox"],input[type="radio"]{flex-grow:0;height:29.7px;margin-left:0;margin-right:9px;vertical-align:middle}input[type="checkbox"]+label,input[type="radio"]+label{page-break-before:avoid}select[multiple]{min-width:270px}input,textarea,select,button,option,html,body{font-family:Helvetica;font-size:18px;font-stretch:normal;font-style:normal;font-weight:400;line-height:29.7px}kbd,samp,var,output{font-family:Menlo,Monaco,Consolas,"Courier New",monospace;font-size:14.4px}pre{border-left:1.8px solid #59c072;line-height:25.2px;overflow:auto;padding-left:18px}kbd{background:#daf1e0;border-radius:3.6px;color:#2a6f3b;display:inline-block;line-height:18px;padding:3.6px 6.3px 2.7px}kbd{background:#2a6f3b;color:#fff}mark{background:#ffc;padding:0 3.6px}input,textarea,select,button,option,html,body{font-family:Helvetica;font-size:18px;font-stretch:normal;font-style:normal;font-weight:400;line-height:29.7px}h1,h2,h3,h4,h5,h6{color:#000;margin-bottom:18px}h1{font-size:36px;font-weight:500;line-height:41.4px;margin-top:72px}h2{font-size:25.2px;font-weight:400;line-height:30.6px;margin-top:54px}h3{font-size:21.6px;line-height:27px;margin-top:36px}h4{font-size:18px;line-height:23.4px;margin-top:18px}h5{font-size:14.4px;font-weight:bold;line-height:21.6px;text-transform:uppercase}h6{color:#595959;font-size:14.4px;font-weight:bold;line-height:18px;text-transform:uppercase}input,textarea,select,button,option,html,body{font-family:Helvetica;font-size:18px;font-stretch:normal;font-style:normal;font-weight:400;line-height:29.7px}a{color:#000090;text-decoration:none}a:hover{text-decoration:underline}hr{border-bottom:1px solid #595959}figcaption,small{font-size:15.3px}figcaption{color:#595959}var,em,i{font-style:italic}dt,strong,b{font-weight:600}del,s{text-decoration:line-through}ins,u{text-decoration:underline}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}*{border:0;border-collapse:separate;border-spacing:0;box-sizing:border-box;margin:0;max-width:100%;outline:0;padding:0;vertical-align:baseline}html,body{width:100%}html{height:100%}body{color:#1a1919;}p,ul,ol,dl,blockquote,hr,pre,table,form,fieldset,figure,address{margin-bottom:29.7px}section{margin-left:auto;margin-right:auto;width:780px}article,header,footer{padding:43.2px}article{word-wrap: break-word;background:#fff;border:1px solid #d9d9d9;border-radius:7.2px}nav{text-align:center}nav ul{list-style:none;margin-left:0;text-align:center}nav ul li{display:inline-block;margin-left:9px;margin-right:9px;vertical-align:middle}nav ul li:last-child{margin-right:0}ol,ul{margin-left:31.5px}li dl,li ol,li ul{margin-bottom:0}dl{display:inline-block}dt{padding:0 18px}dd{padding:0 18px 4.5px}dd:last-of-type{border-bottom:1.08px solid #595959}dd+dt{border-top:1.08px solid #595959;padding-top:9px}blockquote{border-left:2.16px solid #595959;padding:4.5px 18px 4.5px 15.84px}blockquote footer{color:#595959;font-size:13.5px;margin:0}blockquote p{margin-bottom:0}img{height:auto;margin:0 auto}figure img{display:block}/*# sourceMappingURL=tacit-css-1.3.2.min.css.map */
      input{-webkit-appearance: none;-moz-appearance: none;appearance: none;}
      #carbonads{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",Helvetica,Arial,sans-serif}#carbonads{display:inline;max-width:330px;background-color:#f9f9f9;box-shadow:0 1px 4px 1px hsla(0,0%,0%,.1)}#carbonads a{color:inherit;text-decoration:none}#carbonads a:hover{color:inherit}#carbonads span{position:relative;display:block;overflow:hidden}#carbonads .carbon-wrap{display:flex}.carbon-img{display:block;margin:0;line-height:1}.carbon-img img{display:block}.carbon-text{font-size:13px;padding:10px;line-height:1.5;text-align:left}.carbon-poweredby{display:block;padding:8px 10px;background:repeating-linear-gradient(-45deg,transparent,transparent 5px,hsla(0,0%,0%,.025) 5px,hsla(0,0%,0%,.025) 10px) hsla(203,11%,95%,.4);text-align:center;text-transform:uppercase;letter-spacing:.5px;font-weight:600;font-size:9px;line-height:1}
        .menu-header{text-align:left;width: 100%;margin:20px auto;border-bottom:1px solid #d9d9d9;}.menu-header a {white-space:pre;color: black;font-size: 12pt;font-weight: bold;padding-right: 5px;}header{padding:0 10px;width:780px;margin:auto;}
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/themes/prism.min.css" rel="stylesheet" />
  </head>
  <body>
    <header>
      <nav class="menu-header">
        <small>
            <a href="/">Jobs</a>&bull;
            <a href="/Golang-Developer-Salary-Remote">Salaries</a>&bull;
            <a href="/Companies-Using-Golang">Companies</a>&bull;
            <a href="/Golang-Developers">Developers</a>
          <br>
        </small>
      </nav>
    </header>
    <section style="margin:30px auto;">
      <article>
	      <h1 class="code-line" data-line-start=0 data-line-end=1 ><a id="Golang_httptrace_Example_0"></a>Golang httptrace Example</h1>
<p class="has-line-data" data-line-start="2" data-line-end="4">The <a href="https://golang.org/pkg/net/http/httptrace/">httptrace package</a> is a new package included in the Go (Golang) standard library from Go1.7. The package is extremely useful if you want to monitor the performance of your http requests or if you want to collect and monitor statistics about your http clients. The main idea is the ability to track a set of events that occur within a lifecycle of a http request. For example, dns resolution, tcp connection creation, data written to the tcp connection, data received from the tcp connection and so on.<br>
<script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7ITK3J&placement=golangcafe" id="_carbonads_js"></script><br />
In this artice we are going to have a look at how to use the httptrace package to monitor the performance of our Go (Golang) http requests.</p>
<h3 class="code-line" data-line-start=5 data-line-end=6 ><a id="1_Initialising_httptraceClientTrace_5"></a>1. Initialising httptrace.ClientTrace</h3>
<p class="has-line-data" data-line-start="7" data-line-end="8">The main exported type from the httptrace package is the ClientTrace struct type. It is used to define the events we want to listen to. Those events are defined as functions and also known as “hooks”. Let’s have a look at some of them.</p>
<p class="has-line-data" data-line-start="9" data-line-end="10">This is a stripped-down version of the <a href="https://golang.org/pkg/net/http/httptrace/#ClientTrace">httptrace.ClientTrace</a> struct</p>
<blockquote>
<p class="has-line-data" data-line-start="11" data-line-end="12">ClientTrace is a set of hooks to run at various stages of an outgoing HTTP request. Any particular hook may be nil</p>
</blockquote>
<pre><code class="language-go" data-line-start="15" data-line-end="51">type ClientTrace struct {
    // GetConn is called before a connection is created or
    // retrieved from an idle pool. The hostPort is the
    // "host:port" of the target or proxy. GetConn is called even
    // if there's already an idle cached connection available.
    GetConn func(hostPort string)

    // GotConn is called after a successful connection is
    // obtained. There is no hook for failure to obtain a
    // connection; instead, use the error from
    // Transport.RoundTrip.
    GotConn func(GotConnInfo)

    [...]

    // DNSStart is called when a DNS lookup begins.
    DNSStart func(DNSStartInfo)

    // DNSDone is called when a DNS lookup ends.
    DNSDone func(DNSDoneInfo)

    // ConnectStart is called when a new connection's Dial begins.
    // If net.Dialer.DualStack (IPv6 "Happy Eyeballs") support is
    // enabled, this may be called multiple times.
    ConnectStart func(network, addr string)

    // ConnectDone is called when a new connection's Dial
    // completes. The provided err indicates whether the
    // connection completedly successfully.
    // If net.Dialer.DualStack ("Happy Eyeballs") support is
    // enabled, this may be called multiple times.
    ConnectDone func(network, addr string, err error)

    [...]
}
</code></pre>
<p class="has-line-data" data-line-start="52" data-line-end="53">Each of the functions you see defined in the ClientTrace are the events you want to listen to when creating and sending an http request in Go. Let’s use some of those to track events in our http request example.</p>
<pre><code class="language-go" data-line-start="55" data-line-end="76">package main

import (
    "fmt"
    "log"
    "net/http"
    "net/http/httptrace"
)

func main() {
    req, _ := http.NewRequest(http.MethodGet, "http://example.com", nil)
    clientTrace := &amp;httptrace.ClientTrace{
        GetConn:      func(hostPort string) { fmt.Println("starting to create conn ", hostPort) },
        DNSStart:     func(info httptrace.DNSStartInfo) { fmt.Println("starting to look up dns", info) },
        DNSDone:      func(info httptrace.DNSDoneInfo) { fmt.Println("done looking up dns", info) },
        ConnectStart: func(network, addr string) { fmt.Println("starting tcp connection", network, addr) },
        ConnectDone:  func(network, addr string, err error) { fmt.Println("tcp connection created", network, addr, err) },
        GotConn:      func(info httptrace.GotConnInfo) { fmt.Println("connection established", info) },
    }
}
</code></pre>
<h3 class="code-line" data-line-start=77 data-line-end=78 ><a id="2_Create_a_context_using_httptraceWithClientTrace_77"></a>2. Create a context using httptrace.WithClientTrace</h3>
<p class="has-line-data" data-line-start="79" data-line-end="80">In order to use our client trace instructions (function hooks) we need to attach the struct into a context that is later on passed into the request context and used by the http client. We can do that by using the <a href="https://golang.org/pkg/net/http/httptrace/#WithClientTrace">httptrace.WithClientTrace</a> function</p>
<pre><code class="language-go" data-line-start="82" data-line-end="84">func WithClientTrace(ctx context.Context, trace *ClientTrace) context.Context
</code></pre>
<blockquote>
<p class="has-line-data" data-line-start="85" data-line-end="86">WithClientTrace returns a new context based on the provided parent ctx. HTTP client requests made with the returned context will use the provided trace hooks, in addition to any previous hooks registered with ctx. Any hooks defined in the provided trace will be called first.</p>
</blockquote>
<p class="has-line-data" data-line-start="87" data-line-end="88">Here’s what we will need to add to our example</p>
<pre><code class="language-go" data-line-start="90" data-line-end="92">clientTraceCtx := httptrace.WithClientTrace(req.Context(), clientTrace)
</code></pre>
<h3 class="code-line" data-line-start=93 data-line-end=94 ><a id="3_Use_the_httptraceClientTrace_with_our_HTTP_Client_93"></a>3. Use the httptrace.ClientTrace with our HTTP Client</h3>
<p class="has-line-data" data-line-start="95" data-line-end="96">Our final result is the following. Define the client trace hooks, create a context with the client trace and pass that into our request object.</p>
<pre><code class="language-go" data-line-start="97" data-line-end="124">package main

import (
    "fmt"
    "log"
    "net/http"
    "net/http/httptrace"
)

func main() {
    req, _ := http.NewRequest(http.MethodGet, "http://example.com", nil)
    clientTrace := &httptrace.ClientTrace{
        GetConn:      func(hostPort string) { fmt.Println("starting to create conn ", hostPort) },
        DNSStart:     func(info httptrace.DNSStartInfo) { fmt.Println("starting to look up dns", info) },
        DNSDone:      func(info httptrace.DNSDoneInfo) { fmt.Println("done looking up dns", info) },
        ConnectStart: func(network, addr string) { fmt.Println("starting tcp connection", network, addr) },
        ConnectDone:  func(network, addr string, err error) { fmt.Println("tcp connection created", network, addr, err) },
        GotConn:      func(info httptrace.GotConnInfo) { fmt.Println("connection established", info) },
    }
    clientTraceCtx := httptrace.WithClientTrace(req.Context(), clientTrace)
    req = req.WithContext(clientTraceCtx)
    _, err := http.DefaultClient.Do(req)
    if err != nil {
        log.Fatal(err)
    }
}
</code></pre>
<p class="has-line-data" data-line-start="125" data-line-end="126">Source code on Go playground <a href="https://play.golang.org/p/iJ9HDabEWMu">https://play.golang.org/p/iJ9HDabEWMu</a></p>
<p class="has-line-data" data-line-start="127" data-line-end="128">Expected result</p>
<pre><code class="language-go" data-line-start="130" data-line-end="137">starting to create conn  example.com:80
starting to look up dns {example.com}
done looking up dns {[{93.184.216.34 } {2606:2800:220:1:248:1893:25c8:1946 }] &lt;nil&gt; false}
starting tcp connection tcp 93.184.216.34:80
tcp connection created tcp 93.184.216.34:80 &lt;nil&gt;
connection established {0xc000010010 false false 0s}
</code></pre>
<p class="has-line-data" data-line-start="138" data-line-end="139">These are just a subset of the possible events you can use to track your outgoing HTTP requests in Go. But as you can see from this example this is already extremely useful to track down what’s happening and troubleshooting your http clients</p>
<script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7ITK3J&placement=golangcafe" id="_carbonads_js"></script><br />
<iframe width="560" height="315" src="https://www.youtube.com/embed/u3YWN4TF81w" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </article>
          <article class="line-item" style="margin-top:20px;">
		  <div style="width: 50%;font-size:15pt;text-align:center;font-weight:bold;display:table;margin:20px auto;" id="email-subscribe-item-text">Join the Golang Developers Community on Golang Cafe</div>
                <input type="submit" onclick="window.location.href='/Submit-Developer-Profile'" id="email-subscribe-item-btn" value="Join the Community" style="width:50%;display:table;margin:5px auto;"/>
            </article>
  </section>
  <footer>
    <nav>
      <small>    
        <a href="/">Golang Jobs</a> &bull;
        <a href="/about">About Golang Cafe</a>
        <br>
      </small>
    </nav>
  </footer>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/prism.min.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-go.min.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-javascript.js"></script>

  
</body>
</html>
